import { Inject, Injectable, Optional } from '@angular/core';
import { ComponentStore } from '@ngrx/component-store';
import { WalletNotConnectedError, WalletNotReadyError, } from '@solana/wallet-adapter-base';
import { combineLatest, defer, EMPTY, from, of, Subject, throwError } from 'rxjs';
import { catchError, concatMap, filter, finalize, first, map, switchMap, tap, withLatestFrom } from 'rxjs/operators';
import { fromAdapterEvent, isNotNull } from '../operators';
import { LocalStorageService } from './local-storage';
import { WalletNotSelectedError } from './wallet.errors';
import { signAllTransactions, signMessage, signTransaction } from './wallet.signer';
import { WALLET_CONFIG } from './wallet.tokens';
import * as i0 from "@angular/core";
export const WALLET_DEFAULT_CONFIG = {
    wallets: [],
    autoConnect: false,
    localStorageKey: 'walletName',
};
const initialState = {
    wallet: null,
    adapter: null,
    ready: false,
    connected: false,
    publicKey: null,
};
export class WalletStore extends ComponentStore {
    constructor(_config) {
        var _a, _b, _c;
        super();
        this._config = _config;
        this._error = new Subject();
        this._localStorage = new LocalStorageService(((_a = this._config) === null || _a === void 0 ? void 0 : _a.localStorageKey) || 'walletName', null);
        this.wallets$ = this.select((state) => state.wallets);
        this.autoConnect$ = this.select((state) => state.autoConnect);
        this.wallet$ = this.select((state) => state.wallet);
        this.adapter$ = this.select((state) => state.adapter);
        this.publicKey$ = this.select((state) => state.publicKey);
        this.ready$ = this.select((state) => state.ready);
        this.connecting$ = this.select((state) => state.connecting);
        this.disconnecting$ = this.select((state) => state.disconnecting);
        this.connected$ = this.select((state) => state.connected);
        this.name$ = this.select((state) => state.name);
        this.error$ = this._error.asObservable();
        this.anchorWallet$ = this.select(this.publicKey$, this.adapter$, this.connected$, (publicKey, adapter, connected) => {
            const adapterSignTransaction = adapter && 'signTransaction' in adapter ? signTransaction(adapter, connected, this._error) : undefined;
            const adapterSignAllTransactions = adapter && 'signAllTransactions' in adapter
                ? signAllTransactions(adapter, connected, this._error)
                : undefined;
            return publicKey && adapterSignTransaction && adapterSignAllTransactions
                ? {
                    publicKey,
                    signTransaction: (transaction) => adapterSignTransaction(transaction).toPromise(),
                    signAllTransactions: (transactions) => adapterSignAllTransactions(transactions).toPromise(),
                }
                : undefined;
        }, { debounce: true });
        // Map of wallet names to wallets
        this._walletsByName$ = this.select(this.wallets$, (wallets) => wallets.reduce((walletsByName, wallet) => {
            walletsByName[wallet.name] = wallet;
            return walletsByName;
        }, {}));
        // When the selected wallet changes, initialize the state
        this.onWalletChanged = this.effect(() => combineLatest([this.name$, this._walletsByName$]).pipe(tap(([name, walletsByName]) => {
            const wallet = (name && walletsByName[name]) || null;
            const adapter = wallet && wallet.adapter;
            if (adapter) {
                const { publicKey, connected } = adapter;
                this.patchState({
                    name,
                    adapter,
                    wallet,
                    publicKey,
                    connected,
                    ready: false,
                });
                // FIXME: Asynchronously update the ready state
            }
            else {
                this.patchState(initialState);
            }
        })));
        // If autoConnect is enabled, try to connect when the adapter changes and is ready
        this.autoConnect = this.effect(() => {
            return combineLatest([
                this.autoConnect$,
                this.adapter$.pipe(isNotNull),
                this.ready$,
                this.connecting$,
                this.connected$,
            ]).pipe(filter(([autoConnect, , ready, connecting, connected]) => autoConnect && ready && !connecting && !connected), concatMap(([, adapter]) => {
                this.patchState({ connecting: true });
                return from(defer(() => adapter.connect())).pipe(catchError(() => {
                    // Clear the selected wallet
                    this.patchState({ name: null });
                    // Don't throw error, but onError will still be called
                    return of(null);
                }), finalize(() => this.patchState({ connecting: false })));
            }));
        });
        // Select a wallet by name
        this.selectWallet = this.effect((newName$) => {
            return newName$.pipe(concatMap((action) => of(action).pipe(withLatestFrom(this.name$, this.adapter$))), filter(([newName, name]) => newName !== name), concatMap(([newName, , adapter]) => {
                if (!adapter) {
                    return of(newName);
                }
                else {
                    return from(defer(() => adapter.disconnect())).pipe(map(() => newName));
                }
            }), tap((newName) => {
                this._localStorage.setItem(newName);
                this.patchState({ name: newName });
            }));
        });
        // Handle the adapter's connect event
        this.onConnect = this.effect(() => {
            return this.adapter$.pipe(isNotNull, switchMap((adapter) => fromAdapterEvent(adapter, 'connect').pipe(tap(() => {
                const { connected, publicKey } = adapter;
                this.patchState({
                    connected,
                    publicKey,
                });
            }))));
        });
        // Handle the adapter's disconnect event
        this.onDisconnect = this.effect(() => {
            return this.adapter$.pipe(isNotNull, switchMap((adapter) => fromAdapterEvent(adapter, 'disconnect').pipe(tap(() => this.patchState({ name: null })))));
        });
        // Handle the adapter's error event
        this.onError = this.effect(() => {
            return this.adapter$.pipe(isNotNull, switchMap((adapter) => fromAdapterEvent(adapter, 'error').pipe(tap((error) => this._error.next(error)))));
        });
        this._config = Object.assign(Object.assign({}, WALLET_DEFAULT_CONFIG), this._config);
        this.setState(Object.assign(Object.assign({}, initialState), { wallets: ((_b = this._config) === null || _b === void 0 ? void 0 : _b.wallets) || [], name: this._localStorage.value, connecting: false, disconnecting: false, autoConnect: ((_c = this._config) === null || _c === void 0 ? void 0 : _c.autoConnect) || false }));
    }
    // Connect the adapter to the wallet
    connect() {
        return combineLatest([
            this.connecting$,
            this.disconnecting$,
            this.connected$,
            this.wallet$,
            this.adapter$,
            this.ready$,
        ]).pipe(first(), filter(([connecting, disconnecting, connected]) => !connected && !connecting && !disconnecting), concatMap(([, , , wallet, adapter, ready]) => {
            if (!wallet || !adapter) {
                const error = new WalletNotSelectedError();
                this._error.next(error);
                return throwError(error);
            }
            if (!ready) {
                this.patchState({ name: null });
                if (typeof window !== 'undefined') {
                    window.open(wallet.url, '_blank');
                }
                const error = new WalletNotReadyError();
                this._error.next(error);
                return throwError(error);
            }
            this.patchState({ connecting: true });
            return from(defer(() => adapter.connect())).pipe(catchError((error) => {
                this.patchState({ name: null });
                return throwError(error);
            }), finalize(() => this.patchState({ connecting: false })));
        }));
    }
    // Disconnect the adapter from the wallet
    disconnect() {
        return combineLatest([this.disconnecting$, this.adapter$]).pipe(first(), filter(([disconnecting]) => !disconnecting), concatMap(([, adapter]) => {
            if (!adapter) {
                this.patchState({ name: null });
                return EMPTY;
            }
            else {
                this.patchState({ disconnecting: true });
                return from(defer(() => adapter.disconnect())).pipe(finalize(() => this.patchState({ disconnecting: false, name: null })));
            }
        }));
    }
    // Send a transaction using the provided connection
    sendTransaction(transaction, connection, options) {
        return combineLatest([this.adapter$, this.connected$]).pipe(first(), concatMap(([adapter, connected]) => {
            if (!adapter) {
                const error = new WalletNotSelectedError();
                this._error.next(error);
                return throwError(error);
            }
            if (!connected) {
                const error = new WalletNotConnectedError();
                this._error.next(error);
                return throwError(error);
            }
            return from(defer(() => adapter.sendTransaction(transaction, connection, options)));
        }));
    }
    // Sign a transaction if the wallet supports it
    signTransaction(transaction) {
        const { adapter, connected } = this.get();
        return adapter && 'signTransaction' in adapter
            ? signTransaction(adapter, connected, this._error)(transaction)
            : undefined;
    }
    // Sign multiple transactions if the wallet supports it
    signAllTransactions(transactions) {
        const { adapter, connected } = this.get();
        return adapter && 'signAllTransactions' in adapter
            ? signAllTransactions(adapter, connected, this._error)(transactions)
            : undefined;
    }
    // Sign an arbitrary message if the wallet supports it
    signMessage(message) {
        const { adapter, connected } = this.get();
        return adapter && 'signMessage' in adapter ? signMessage(adapter, connected, this._error)(message) : undefined;
    }
}
WalletStore.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: WalletStore, deps: [{ token: WALLET_CONFIG, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });
WalletStore.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: WalletStore });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.15", ngImport: i0, type: WalletStore, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [WALLET_CONFIG]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2FsbGV0LnN0b3JlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3dhbGxldC93YWxsZXQuc3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUN2RCxPQUFPLEVBS0gsdUJBQXVCLEVBQ3ZCLG1CQUFtQixHQUN0QixNQUFNLDZCQUE2QixDQUFDO0FBRXJDLE9BQU8sRUFBRSxhQUFhLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQWMsRUFBRSxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDOUYsT0FBTyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsY0FBYyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFckgsT0FBTyxFQUFFLGdCQUFnQixFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUMzRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsV0FBVyxFQUFFLGVBQWUsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3BGLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQzs7QUFHaEQsTUFBTSxDQUFDLE1BQU0scUJBQXFCLEdBQWlCO0lBQy9DLE9BQU8sRUFBRSxFQUFFO0lBQ1gsV0FBVyxFQUFFLEtBQUs7SUFDbEIsZUFBZSxFQUFFLFlBQVk7Q0FDaEMsQ0FBQztBQUVGLE1BQU0sWUFBWSxHQU1kO0lBQ0EsTUFB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QyxPQUFPLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxZQUFZLENBQUM7WUFDcEUsQ0FBQyxDQUFDLFNBQVMsQ0FBQztJQUNwQixDQUFDO0lBRUQsc0RBQXNEO0lBQ3RELFdBQVcsQ0FBQyxPQUFtQjtRQUMzQixNQUFNLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUUxQyxPQUFPLE9BQU8sSUFBSSxhQUFhLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztJQUNuSCxDQUFDOzt5R0FwU1EsV0FBVyxrQkFtRFIsYUFBYTs2R0FuRGhCLFdBQVc7NEZBQVgsV0FBVztrQkFEdkIsVUFBVTs7MEJBbURGLFFBQVE7OzBCQUNSLE1BQU07MkJBQUMsYUFBYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENvbXBvbmVudFN0b3JlIH0gZnJvbSAnQG5ncngvY29tcG9uZW50LXN0b3JlJztcbmltcG9ydCB7XG4gICAgQWRhcHRlcixcbiAgICBTZW5kVHJhbnNhY3Rpb25PcHRpb25zLFxuICAgIFdhbGxldCxcbiAgICBXYWxsZXROYW1lLFxuICAgIFdhbGxldE5vdENvbm5lY3RlZEVycm9yLFxuICAgIFdhbGxldE5vdFJlYWR5RXJyb3IsXG59IGZyb20gJ0Bzb2xhbmEvd2FsbGV0LWFkYXB0ZXItYmFzZSc7XG5pbXBvcnQgeyBDb25uZWN0aW9uLCBQdWJsaWNLZXksIFRyYW5zYWN0aW9uIH0gZnJvbSAnQHNvbGFuYS93ZWIzLmpzJztcbmltcG9ydCB7IGNvbWJpbmVMYXRlc3QsIGRlZmVyLCBFTVBUWSwgZnJvbSwgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QsIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIGNvbmNhdE1hcCwgZmlsdGVyLCBmaW5hbGl6ZSwgZmlyc3QsIG1hcCwgc3dpdGNoTWFwLCB0YXAsIHdpdGhMYXRlc3RGcm9tIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBmcm9tQWRhcHRlckV2ZW50LCBpc05vdE51bGwgfSBmcm9tICcuLi9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgTG9jYWxTdG9yYWdlU2VydmljZSB9IGZyb20gJy4vbG9jYWwtc3RvcmFnZSc7XG5pbXBvcnQgeyBXYWxsZXROb3RTZWxlY3RlZEVycm9yIH0gZnJvbSAnLi93YWxsZXQuZXJyb3JzJztcbmltcG9ydCB7IHNpZ25BbGxUcmFuc2FjdGlvbnMsIHNpZ25NZXNzYWdlLCBzaWduVHJhbnNhY3Rpb24gfSBmcm9tICcuL3dhbGxldC5zaWduZXInO1xuaW1wb3J0IHsgV0FMTEVUX0NPTkZJRyB9IGZyb20gJy4vd2FsbGV0LnRva2Vucyc7XG5pbXBvcnQgeyBXYWxsZXRDb25maWcsIFdhbGxldFN0YXRlIH0gZnJvbSAnLi93YWxsZXQudHlwZXMnO1xuXG5leHBvcnQgY29uc3QgV0FMTEVUX0RFRkFVTFRfQ09ORklHOiBXYWxsZXRDb25maWcgPSB7XG4gICAgd2FsbGV0czogW10sXG4gICAgYXV0b0Nvbm5lY3Q6IGZhbHNlLFxuICAgIGxvY2FsU3RvcmFnZUtleTogJ3dhbGxldE5hbWUnLFxufTtcblxuY29uc3QgaW5pdGlhbFN0YXRlOiB7XG4gICAgd2FsbGV0OiBXYWxsZXQgfCBudWxsO1xuICAgIGFkYXB0ZXI6IEFkYXB0ZXIgfCBudWxsO1xuICAgIHJlYWR5OiBib29sZWFuO1xuICAgIGNvbm5lY3RlZDogYm9vbGVhbjtcbiAgICBwdWJsaWNLZXk6IFB1YmxpY0tleSB8IG51bGw7XG59ID0ge1xuICAgIHdhbGxldDogbnVsbCxcbiAgICBhZGFwdGVyOiBudWxsLFxuICAgIHJlYWR5OiBmYWxzZSxcbiAgICBjb25uZWN0ZWQ6IGZhbHNlLFxuICAgIHB1YmxpY0tleTogbnVsbCxcbn07XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBXYWxsZXRTdG9yZSBleHRlbmRzIENvbXBvbmVudFN0b3JlPFdhbGxldFN0YXRlPiB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfZXJyb3IgPSBuZXcgU3ViamVjdCgpO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX2xvY2FsU3RvcmFnZSA9IG5ldyBMb2NhbFN0b3JhZ2VTZXJ2aWNlPFdhbGxldE5hbWUgfCBudWxsPihcbiAgICAgICAgdGhpcy5fY29uZmlnPy5sb2NhbFN0b3JhZ2VLZXkgfHwgJ3dhbGxldE5hbWUnLFxuICAgICAgICBudWxsXG4gICAgKTtcbiAgICByZWFkb25seSB3YWxsZXRzJCA9IHRoaXMuc2VsZWN0KChzdGF0ZSkgPT4gc3RhdGUud2FsbGV0cyk7XG4gICAgcmVhZG9ubHkgYXV0b0Nvbm5lY3QkID0gdGhpcy5zZWxlY3QoKHN0YXRlKSA9PiBzdGF0ZS5hdXRvQ29ubmVjdCk7XG4gICAgcmVhZG9ubHkgd2FsbGV0JCA9IHRoaXMuc2VsZWN0KChzdGF0ZSkgPT4gc3RhdGUud2FsbGV0KTtcbiAgICByZWFkb25seSBhZGFwdGVyJCA9IHRoaXMuc2VsZWN0KChzdGF0ZSkgPT4gc3RhdGUuYWRhcHRlcik7XG4gICAgcmVhZG9ubHkgcHVibGljS2V5JCA9IHRoaXMuc2VsZWN0KChzdGF0ZSkgPT4gc3RhdGUucHVibGljS2V5KTtcbiAgICByZWFkb25seSByZWFkeSQgPSB0aGlzLnNlbGVjdCgoc3RhdGUpID0+IHN0YXRlLnJlYWR5KTtcbiAgICByZWFkb25seSBjb25uZWN0aW5nJCA9IHRoaXMuc2VsZWN0KChzdGF0ZSkgPT4gc3RhdGUuY29ubmVjdGluZyk7XG4gICAgcmVhZG9ubHkgZGlzY29ubmVjdGluZyQgPSB0aGlzLnNlbGVjdCgoc3RhdGUpID0+IHN0YXRlLmRpc2Nvbm5lY3RpbmcpO1xuICAgIHJlYWRvbmx5IGNvbm5lY3RlZCQgPSB0aGlzLnNlbGVjdCgoc3RhdGUpID0+IHN0YXRlLmNvbm5lY3RlZCk7XG4gICAgcmVhZG9ubHkgbmFtZSQgPSB0aGlzLnNlbGVjdCgoc3RhdGUpID0+IHN0YXRlLm5hbWUpO1xuICAgIHJlYWRvbmx5IGVycm9yJCA9IHRoaXMuX2Vycm9yLmFzT2JzZXJ2YWJsZSgpO1xuICAgIHJlYWRvbmx5IGFuY2hvcldhbGxldCQgPSB0aGlzLnNlbGVjdChcbiAgICAgICAgdGhpcy5wdWJsaWNLZXkkLFxuICAgICAgICB0aGlzLmFkYXB0ZXIkLFxuICAgICAgICB0aGlzLmNvbm5lY3RlZCQsXG4gICAgICAgIChwdWJsaWNLZXksIGFkYXB0ZXIsIGNvbm5lY3RlZCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgYWRhcHRlclNpZ25UcmFuc2FjdGlvbiA9XG4gICAgICAgICAgICAgICAgYWRhcHRlciAmJiAnc2lnblRyYW5zYWN0aW9uJyBpbiBhZGFwdGVyID8gc2lnblRyYW5zYWN0aW9uKGFkYXB0ZXIsIGNvbm5lY3RlZCwgdGhpcy5fZXJyb3IpIDogdW5kZWZpbmVkO1xuICAgICAgICAgICAgY29uc3QgYWRhcHRlclNpZ25BbGxUcmFuc2FjdGlvbnMgPVxuICAgICAgICAgICAgICAgIGFkYXB0ZXIgJiYgJ3NpZ25BbGxUcmFuc2FjdGlvbnMnIGluIGFkYXB0ZXJcbiAgICAgICAgICAgICAgICAgICAgPyBzaWduQWxsVHJhbnNhY3Rpb25zKGFkYXB0ZXIsIGNvbm5lY3RlZCwgdGhpcy5fZXJyb3IpXG4gICAgICAgICAgICAgICAgICAgIDogdW5kZWZpbmVkO1xuXG4gICAgICAgICAgICByZXR1cm4gcHVibGljS2V5ICYmIGFkYXB0ZXJTaWduVHJhbnNhY3Rpb24gJiYgYWRhcHRlclNpZ25BbGxUcmFuc2FjdGlvbnNcbiAgICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgICAgICBwdWJsaWNLZXksXG4gICAgICAgICAgICAgICAgICAgICAgc2lnblRyYW5zYWN0aW9uOiAodHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uKSA9PiBhZGFwdGVyU2lnblRyYW5zYWN0aW9uKHRyYW5zYWN0aW9uKS50b1Byb21pc2UoKSxcbiAgICAgICAgICAgICAgICAgICAgICBzaWduQWxsVHJhbnNhY3Rpb25zOiAodHJhbnNhY3Rpb25zOiBUcmFuc2FjdGlvbltdKSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICBhZGFwdGVyU2lnbkFsbFRyYW5zYWN0aW9ucyh0cmFuc2FjdGlvbnMpLnRvUHJvbWlzZSgpLFxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIDogdW5kZWZpbmVkO1xuICAgICAgICB9LFxuICAgICAgICB7IGRlYm91bmNlOiB0cnVlIH1cbiAgICApO1xuXG4gICAgLy8gTWFwIG9mIHdhbGxldCBuYW1lcyB0byB3YWxsZXRzXG4gICAgcHJpdmF0ZSByZWFkb25seSBfd2FsbGV0c0J5TmFtZSQgPSB0aGlzLnNlbGVjdCh0aGlzLndhbGxldHMkLCAod2FsbGV0cykgPT5cbiAgICAgICAgd2FsbGV0cy5yZWR1Y2U8UmVjb3JkPFdhbGxldE5hbWUsIFdhbGxldD4+KCh3YWxsZXRzQnlOYW1lLCB3YWxsZXQpID0+IHtcbiAgICAgICAgICAgIHdhbGxldHNCeU5hbWVbd2FsbGV0Lm5hbWVdID0gd2FsbGV0O1xuICAgICAgICAgICAgcmV0dXJuIHdhbGxldHNCeU5hbWU7XG4gICAgICAgIH0sIHt9KVxuICAgICk7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgQE9wdGlvbmFsKClcbiAgICAgICAgQEluamVjdChXQUxMRVRfQ09ORklHKVxuICAgICAgICBwcml2YXRlIF9jb25maWc6IFdhbGxldENvbmZpZ1xuICAgICkge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIHRoaXMuX2NvbmZpZyA9IHtcbiAgICAgICAgICAgIC4uLldBTExFVF9ERUZBVUxUX0NPTkZJRyxcbiAgICAgICAgICAgIC4uLnRoaXMuX2NvbmZpZyxcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIC4uLmluaXRpYWxTdGF0ZSxcbiAgICAgICAgICAgIHdhbGxldHM6IHRoaXMuX2NvbmZpZz8ud2FsbGV0cyB8fCBbXSxcbiAgICAgICAgICAgIG5hbWU6IHRoaXMuX2xvY2FsU3RvcmFnZS52YWx1ZSxcbiAgICAgICAgICAgIGNvbm5lY3Rpbmc6IGZhbHNlLFxuICAgICAgICAgICAgZGlzY29ubmVjdGluZzogZmFsc2UsXG4gICAgICAgICAgICBhdXRvQ29ubmVjdDogdGhpcy5fY29uZmlnPy5hdXRvQ29ubmVjdCB8fCBmYWxzZSxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gV2hlbiB0aGUgc2VsZWN0ZWQgd2FsbGV0IGNoYW5nZXMsIGluaXRpYWxpemUgdGhlIHN0YXRlXG4gICAgcmVhZG9ubHkgb25XYWxsZXRDaGFuZ2VkID0gdGhpcy5lZmZlY3QoKCkgPT5cbiAgICAgICAgY29tYmluZUxhdGVzdChbdGhpcy5uYW1lJCwgdGhpcy5fd2FsbGV0c0J5TmFtZSRdKS5waXBlKFxuICAgICAgICAgICAgdGFwKChbbmFtZSwgd2FsbGV0c0J5TmFtZV0pID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB3YWxsZXQgPSAobmFtZSAmJiB3YWxsZXRzQnlOYW1lW25hbWVdKSB8fCBudWxsO1xuICAgICAgICAgICAgICAgIGNvbnN0IGFkYXB0ZXIgPSB3YWxsZXQgJiYgd2FsbGV0LmFkYXB0ZXI7XG5cbiAgICAgICAgICAgICAgICBpZiAoYWRhcHRlcikge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB7IHB1YmxpY0tleSwgY29ubmVjdGVkIH0gPSBhZGFwdGVyO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnBhdGNoU3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFkYXB0ZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICB3YWxsZXQsXG4gICAgICAgICAgICAgICAgICAgICAgICBwdWJsaWNLZXksXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0ZWQsXG4gICAgICAgICAgICAgICAgICAgICAgICByZWFkeTogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIEZJWE1FOiBBc3luY2hyb25vdXNseSB1cGRhdGUgdGhlIHJlYWR5IHN0YXRlXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXRjaFN0YXRlKGluaXRpYWxTdGF0ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICk7XG5cbiAgICAvLyBJZiBhdXRvQ29ubmVjdCBpcyBlbmFibGVkLCB0cnkgdG8gY29ubmVjdCB3aGVuIHRoZSBhZGFwdGVyIGNoYW5nZXMgYW5kIGlzIHJlYWR5XG4gICAgcmVhZG9ubHkgYXV0b0Nvbm5lY3QgPSB0aGlzLmVmZmVjdCgoKSA9PiB7XG4gICAgICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KFtcbiAgICAgICAgICAgIHRoaXMuYXV0b0Nvbm5lY3QkLFxuICAgICAgICAgICAgdGhpcy5hZGFwdGVyJC5waXBlKGlzTm90TnVsbCksXG4gICAgICAgICAgICB0aGlzLnJlYWR5JCxcbiAgICAgICAgICAgIHRoaXMuY29ubmVjdGluZyQsXG4gICAgICAgICAgICB0aGlzLmNvbm5lY3RlZCQsXG4gICAgICAgIF0pLnBpcGUoXG4gICAgICAgICAgICBmaWx0ZXIoXG4gICAgICAgICAgICAgICAgKFthdXRvQ29ubmVjdCwgLCByZWFkeSwgY29ubmVjdGluZywgY29ubmVjdGVkXSkgPT4gYXV0b0Nvbm5lY3QgJiYgcmVhZHkgJiYgIWNvbm5lY3RpbmcgJiYgIWNvbm5lY3RlZFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIGNvbmNhdE1hcCgoWywgYWRhcHRlcl0pID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnBhdGNoU3RhdGUoeyBjb25uZWN0aW5nOiB0cnVlIH0pO1xuICAgICAgICAgICAgICAgIHJldHVybiBmcm9tKGRlZmVyKCgpID0+IGFkYXB0ZXIuY29ubmVjdCgpKSkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBDbGVhciB0aGUgc2VsZWN0ZWQgd2FsbGV0XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhdGNoU3RhdGUoeyBuYW1lOiBudWxsIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gRG9uJ3QgdGhyb3cgZXJyb3IsIGJ1dCBvbkVycm9yIHdpbGwgc3RpbGwgYmUgY2FsbGVkXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YobnVsbCk7XG4gICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgICBmaW5hbGl6ZSgoKSA9PiB0aGlzLnBhdGNoU3RhdGUoeyBjb25uZWN0aW5nOiBmYWxzZSB9KSlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9KTtcblxuICAgIC8vIFNlbGVjdCBhIHdhbGxldCBieSBuYW1lXG4gICAgcmVhZG9ubHkgc2VsZWN0V2FsbGV0ID0gdGhpcy5lZmZlY3QoKG5ld05hbWUkOiBPYnNlcnZhYmxlPFdhbGxldE5hbWUgfCBudWxsPikgPT4ge1xuICAgICAgICByZXR1cm4gbmV3TmFtZSQucGlwZShcbiAgICAgICAgICAgIGNvbmNhdE1hcCgoYWN0aW9uKSA9PiBvZihhY3Rpb24pLnBpcGUod2l0aExhdGVzdEZyb20odGhpcy5uYW1lJCwgdGhpcy5hZGFwdGVyJCkpKSxcbiAgICAgICAgICAgIGZpbHRlcigoW25ld05hbWUsIG5hbWVdKSA9PiBuZXdOYW1lICE9PSBuYW1lKSxcbiAgICAgICAgICAgIGNvbmNhdE1hcCgoW25ld05hbWUsICwgYWRhcHRlcl0pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIWFkYXB0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKG5ld05hbWUpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmcm9tKGRlZmVyKCgpID0+IGFkYXB0ZXIuZGlzY29ubmVjdCgpKSkucGlwZShtYXAoKCkgPT4gbmV3TmFtZSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgdGFwKChuZXdOYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fbG9jYWxTdG9yYWdlLnNldEl0ZW0obmV3TmFtZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5wYXRjaFN0YXRlKHsgbmFtZTogbmV3TmFtZSB9KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgfSk7XG5cbiAgICAvLyBIYW5kbGUgdGhlIGFkYXB0ZXIncyBjb25uZWN0IGV2ZW50XG4gICAgcmVhZG9ubHkgb25Db25uZWN0ID0gdGhpcy5lZmZlY3QoKCkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5hZGFwdGVyJC5waXBlKFxuICAgICAgICAgICAgaXNOb3ROdWxsLFxuICAgICAgICAgICAgc3dpdGNoTWFwKChhZGFwdGVyKSA9PlxuICAgICAgICAgICAgICAgIGZyb21BZGFwdGVyRXZlbnQoYWRhcHRlciwgJ2Nvbm5lY3QnKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICB0YXAoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBjb25uZWN0ZWQsIHB1YmxpY0tleSB9ID0gYWRhcHRlcjtcblxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXRjaFN0YXRlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0ZWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHVibGljS2V5LFxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKVxuICAgICAgICApO1xuICAgIH0pO1xuXG4gICAgLy8gSGFuZGxlIHRoZSBhZGFwdGVyJ3MgZGlzY29ubmVjdCBldmVudFxuICAgIHJlYWRvbmx5IG9uRGlzY29ubmVjdCA9IHRoaXMuZWZmZWN0KCgpID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYWRhcHRlciQucGlwZShcbiAgICAgICAgICAgIGlzTm90TnVsbCxcbiAgICAgICAgICAgIHN3aXRjaE1hcCgoYWRhcHRlcikgPT5cbiAgICAgICAgICAgICAgICBmcm9tQWRhcHRlckV2ZW50KGFkYXB0ZXIsICdkaXNjb25uZWN0JykucGlwZSh0YXAoKCkgPT4gdGhpcy5wYXRjaFN0YXRlKHsgbmFtZTogbnVsbCB9KSkpXG4gICAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgfSk7XG5cbiAgICAvLyBIYW5kbGUgdGhlIGFkYXB0ZXIncyBlcnJvciBldmVudFxuICAgIHJlYWRvbmx5IG9uRXJyb3IgPSB0aGlzLmVmZmVjdCgoKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmFkYXB0ZXIkLnBpcGUoXG4gICAgICAgICAgICBpc05vdE51bGwsXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKGFkYXB0ZXIpID0+IGZyb21BZGFwdGVyRXZlbnQoYWRhcHRlciwgJ2Vycm9yJykucGlwZSh0YXAoKGVycm9yKSA9PiB0aGlzLl9lcnJvci5uZXh0KGVycm9yKSkpKVxuICAgICAgICApO1xuICAgIH0pO1xuXG4gICAgLy8gQ29ubmVjdCB0aGUgYWRhcHRlciB0byB0aGUgd2FsbGV0XG4gICAgY29ubmVjdCgpOiBPYnNlcnZhYmxlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIGNvbWJpbmVMYXRlc3QoW1xuICAgICAgICAgICAgdGhpcy5jb25uZWN0aW5nJCxcbiAgICAgICAgICAgIHRoaXMuZGlzY29ubmVjdGluZyQsXG4gICAgICAgICAgICB0aGlzLmNvbm5lY3RlZCQsXG4gICAgICAgICAgICB0aGlzLndhbGxldCQsXG4gICAgICAgICAgICB0aGlzLmFkYXB0ZXIkLFxuICAgICAgICAgICAgdGhpcy5yZWFkeSQsXG4gICAgICAgIF0pLnBpcGUoXG4gICAgICAgICAgICBmaXJzdCgpLFxuICAgICAgICAgICAgZmlsdGVyKChbY29ubmVjdGluZywgZGlzY29ubmVjdGluZywgY29ubmVjdGVkXSkgPT4gIWNvbm5lY3RlZCAmJiAhY29ubmVjdGluZyAmJiAhZGlzY29ubmVjdGluZyksXG4gICAgICAgICAgICBjb25jYXRNYXAoKFssICwgLCB3YWxsZXQsIGFkYXB0ZXIsIHJlYWR5XSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghd2FsbGV0IHx8ICFhZGFwdGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yID0gbmV3IFdhbGxldE5vdFNlbGVjdGVkRXJyb3IoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZXJyb3IubmV4dChlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoIXJlYWR5KSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGF0Y2hTdGF0ZSh7IG5hbWU6IG51bGwgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cub3Blbih3YWxsZXQudXJsLCAnX2JsYW5rJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBlcnJvciA9IG5ldyBXYWxsZXROb3RSZWFkeUVycm9yKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2Vycm9yLm5leHQoZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdGhpcy5wYXRjaFN0YXRlKHsgY29ubmVjdGluZzogdHJ1ZSB9KTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBmcm9tKGRlZmVyKCgpID0+IGFkYXB0ZXIuY29ubmVjdCgpKSkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGF0Y2hTdGF0ZSh7IG5hbWU6IG51bGwgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgICBmaW5hbGl6ZSgoKSA9PiB0aGlzLnBhdGNoU3RhdGUoeyBjb25uZWN0aW5nOiBmYWxzZSB9KSlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBEaXNjb25uZWN0IHRoZSBhZGFwdGVyIGZyb20gdGhlIHdhbGxldFxuICAgIGRpc2Nvbm5lY3QoKTogT2JzZXJ2YWJsZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KFt0aGlzLmRpc2Nvbm5lY3RpbmckLCB0aGlzLmFkYXB0ZXIkXSkucGlwZShcbiAgICAgICAgICAgIGZpcnN0KCksXG4gICAgICAgICAgICBmaWx0ZXIoKFtkaXNjb25uZWN0aW5nXSkgPT4gIWRpc2Nvbm5lY3RpbmcpLFxuICAgICAgICAgICAgY29uY2F0TWFwKChbLCBhZGFwdGVyXSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghYWRhcHRlcikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnBhdGNoU3RhdGUoeyBuYW1lOiBudWxsIH0pO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXRjaFN0YXRlKHsgZGlzY29ubmVjdGluZzogdHJ1ZSB9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZyb20oZGVmZXIoKCkgPT4gYWRhcHRlci5kaXNjb25uZWN0KCkpKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxpemUoKCkgPT4gdGhpcy5wYXRjaFN0YXRlKHsgZGlzY29ubmVjdGluZzogZmFsc2UsIG5hbWU6IG51bGwgfSkpXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBTZW5kIGEgdHJhbnNhY3Rpb24gdXNpbmcgdGhlIHByb3ZpZGVkIGNvbm5lY3Rpb25cbiAgICBzZW5kVHJhbnNhY3Rpb24oXG4gICAgICAgIHRyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbixcbiAgICAgICAgY29ubmVjdGlvbjogQ29ubmVjdGlvbixcbiAgICAgICAgb3B0aW9ucz86IFNlbmRUcmFuc2FjdGlvbk9wdGlvbnNcbiAgICApOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgICAgICByZXR1cm4gY29tYmluZUxhdGVzdChbdGhpcy5hZGFwdGVyJCwgdGhpcy5jb25uZWN0ZWQkXSkucGlwZShcbiAgICAgICAgICAgIGZpcnN0KCksXG4gICAgICAgICAgICBjb25jYXRNYXAoKFthZGFwdGVyLCBjb25uZWN0ZWRdKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFhZGFwdGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yID0gbmV3IFdhbGxldE5vdFNlbGVjdGVkRXJyb3IoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZXJyb3IubmV4dChlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoIWNvbm5lY3RlZCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBlcnJvciA9IG5ldyBXYWxsZXROb3RDb25uZWN0ZWRFcnJvcigpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9lcnJvci5uZXh0KGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBmcm9tKGRlZmVyKCgpID0+IGFkYXB0ZXIuc2VuZFRyYW5zYWN0aW9uKHRyYW5zYWN0aW9uLCBjb25uZWN0aW9uLCBvcHRpb25zKSkpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBTaWduIGEgdHJhbnNhY3Rpb24gaWYgdGhlIHdhbGxldCBzdXBwb3J0cyBpdFxuICAgIHNpZ25UcmFuc2FjdGlvbih0cmFuc2FjdGlvbjogVHJhbnNhY3Rpb24pOiBPYnNlcnZhYmxlPFRyYW5zYWN0aW9uPiB8IHVuZGVmaW5lZCB7XG4gICAgICAgIGNvbnN0IHsgYWRhcHRlciwgY29ubmVjdGVkIH0gPSB0aGlzLmdldCgpO1xuXG4gICAgICAgIHJldHVybiBhZGFwdGVyICYmICdzaWduVHJhbnNhY3Rpb24nIGluIGFkYXB0ZXJcbiAgICAgICAgICAgID8gc2lnblRyYW5zYWN0aW9uKGFkYXB0ZXIsIGNvbm5lY3RlZCwgdGhpcy5fZXJyb3IpKHRyYW5zYWN0aW9uKVxuICAgICAgICAgICAgOiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgLy8gU2lnbiBtdWx0aXBsZSB0cmFuc2FjdGlvbnMgaWYgdGhlIHdhbGxldCBzdXBwb3J0cyBpdFxuICAgIHNpZ25BbGxUcmFuc2FjdGlvbnModHJhbnNhY3Rpb25zOiBUcmFuc2FjdGlvbltdKTogT2JzZXJ2YWJsZTxUcmFuc2FjdGlvbltdPiB8IHVuZGVmaW5lZCB7XG4gICAgICAgIGNvbnN0IHsgYWRhcHRlciwgY29ubmVjdGVkIH0gPSB0aGlzLmdldCgpO1xuXG4gICAgICAgIHJldHVybiBhZGFwdGVyICYmICdzaWduQWxsVHJhbnNhY3Rpb25zJyBpbiBhZGFwdGVyXG4gICAgICAgICAgICA/IHNpZ25BbGxUcmFuc2FjdGlvbnMoYWRhcHRlciwgY29ubmVjdGVkLCB0aGlzLl9lcnJvcikodHJhbnNhY3Rpb25zKVxuICAgICAgICAgICAgOiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgLy8gU2lnbiBhbiBhcmJpdHJhcnkgbWVzc2FnZSBpZiB0aGUgd2FsbGV0IHN1cHBvcnRzIGl0XG4gICAgc2lnbk1lc3NhZ2UobWVzc2FnZTogVWludDhBcnJheSk6IE9ic2VydmFibGU8VWludDhBcnJheT4gfCB1bmRlZmluZWQge1xuICAgICAgICBjb25zdCB7IGFkYXB0ZXIsIGNvbm5lY3RlZCB9ID0gdGhpcy5nZXQoKTtcblxuICAgICAgICByZXR1cm4gYWRhcHRlciAmJiAnc2lnbk1lc3NhZ2UnIGluIGFkYXB0ZXIgPyBzaWduTWVzc2FnZShhZGFwdGVyLCBjb25uZWN0ZWQsIHRoaXMuX2Vycm9yKShtZXNzYWdlKSA6IHVuZGVmaW5lZDtcbiAgICB9XG59XG4iXX0=